import { createAuthEndpoint, getSessionFromCtx } from "better-auth/api";
import { type GenericEndpointContext, logger } from "better-auth";
import { Creem } from "creem";
import { z } from "zod";
import type { CreemOptions } from "./types.js";
import { resolveSuccessUrl } from "./utils.js";
import type {
  CreateCheckoutInput,
  CreateCheckoutResponse,
} from "./checkout-types.js";
import type { CustomerRequestEntity } from "creem/models/components";

export const CheckoutParams = z.object({
  productId: z.string(),
  requestId: z.string().optional(),
  units: z.number().positive().optional(),
  discountCode: z.string().optional(),
  customer: z
    .object({
      id: z.string().optional(),
      email: z.email().optional(),
    })
    .optional(),
  customField: z.array(z.record(z.string(), z.unknown())).max(3).optional(),
  successUrl: z.string().optional(),
  metadata: z.record(z.string(), z.unknown()).optional(),
  redirect: z.boolean().optional().prefault(false).default(false),
});

export type CheckoutParams = z.infer<typeof CheckoutParams>;

// Re-export types for convenience
export type { CreateCheckoutInput, CreateCheckoutResponse };

/**
 * Check if a user has already used a trial period.
 * Used for automatic trial abuse prevention.
 *
 * @returns true if user has used a trial, false otherwise (or if check fails)
 */
async function checkUserHadTrial(
  ctx: GenericEndpointContext,
  userId: string,
  options: CreemOptions,
): Promise<boolean> {
  // Skip check if persistence is disabled
  const shouldPersist = options.persistSubscriptions !== false;
  if (!shouldPersist) {
    return false;
  }

  try {
    const user = await ctx.context.adapter.findOne<{
      id: string;
      hadTrial?: boolean;
    }>({
      model: "user",
      where: [{ field: "id", value: userId }],
    });

    return user?.hadTrial === true;
  } catch (error) {
    // If check fails, allow the checkout to proceed (fail open)
    // The trial abuse prevention is a convenience feature, not a security feature
    logger.warn(`Failed to check hadTrial status for user ${userId}`);
    return false;
  }
}

const createCheckoutHandler = (creem: Creem, options: CreemOptions) => {
  return async (ctx: GenericEndpointContext) => {
    const body = ctx.body as CheckoutParams;

    if (!options.apiKey) {
      return ctx.json(
        { error: "Creem API key is not configured. Please set the apiKey option when initializing the Creem plugin." },
        { status: 500 },
      );
    }

    try {
      const session = await getSessionFromCtx(ctx);

      // Check if user has already used a trial (trial abuse prevention)
      let userHadTrial = false;
      if (session?.user?.id) {
        userHadTrial = await checkUserHadTrial(ctx, session.user.id, options);
        if (userHadTrial) {
          logger.info(
            `User ${session.user.id} has already used a trial - skipTrial flag will be set`,
          );
        }
      }

      // prefer the customer ID from the session
      const id = session?.user?.creemCustomerId || body.customer?.id;
      // prefer the email from the body over the session
      const email = body.customer?.email || session?.user?.email;

      let customer: CustomerRequestEntity | undefined = undefined

      // prefer using the creem customer ID over email
      if (id) {
        customer ??= { id };
      } else if (email) {
        customer ??= { email };
      }

      const checkout = await creem.checkouts.create({
        productId: body.productId,
        requestId: body.requestId,
        units: body.units,
        discountCode: body.discountCode,
        customer,
        //   customField: body.customField, TODO: Implement proper customField handling
        successUrl: resolveSuccessUrl(
          body.successUrl || options.defaultSuccessUrl,
          ctx,
        ),
        metadata: {
          ...(body.metadata || {}),
          ...(session?.user?.id && {
            referenceId: session.user.id,
          }),
          // Trial abuse prevention: signal to Creem that this user has already had a trial
          // Creem will use this to skip the trial period for returning users
          ...(userHadTrial && {
            skipTrial: true,
          }),
        },
      });

      return ctx.json({
        url: checkout.checkoutUrl,
        redirect: !!body.redirect,
      });
    } catch (error) {
      return ctx.json({ error: "Failed to create checkout" }, { status: 500 });
    }
  };
};

/**
 * Creates the checkout endpoint for the Creem plugin.
 *
 * This endpoint handles creating Creem checkout sessions for authenticated users.
 * It automatically includes the user's session information and redirects to the checkout URL.
 *
 * @param creem - The Creem client instance
 * @param options - Plugin configuration options
 * @returns BetterAuth endpoint configuration
 *
 * @endpoint POST /creem/create-checkout
 *
 * @example
 * Client-side usage:
 * ```typescript
 * const { data, error } = await authClient.creem.createCheckout({
 *   productId: "prod_abc123",
 *   units: 1,
 *   successUrl: "/thank-you"
 * });
 *
 * if (data?.url) {
 *   window.location.href = data.url;
 * }
 * ```
 */
export const createCheckoutEndpoint = (creem: Creem, options: CreemOptions) => {
  return createAuthEndpoint(
    "/creem/create-checkout",
    {
      method: "POST",
      body: CheckoutParams,
    },
    createCheckoutHandler(creem, options),
  );
};
